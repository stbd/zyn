<!doctype html>
<head>
    <title>Zyn - Fileserver</title>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.slim.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/showdownjs/showdown/1.8.6/dist/showdown.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.489/pdf.js"></script>
    <script type="text/javascript" src="{{ static_url('zyn.js') }}"></script>
    <script type="text/javascript" src="{{ static_url('utf8.js') }}"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    <div id="zyn-login-modal" class="w3-modal" style="display: none;">
        <div class="w3-modal-content">

            <div class="w3-container">
                <h2 class="w3-center">Zyn - Login</h2>
                <form class="w3-container" method="post">
                    <label>Username</label>
                    <input class="w3-input w3-border w3-light-grey" type="text" name="username" autofocus>

                    <label>Password</label>
                    <input class="w3-input w3-border w3-light-grey" type="password" name="password">
                    <br />
                    <input class="w3-button w3-blue-grey" type="submit" value="{{ _("login") }}">

                </form>

            </div>
        </div>
    </div>

    <div id="zyn-error-modal" class="w3-modal" style="display: none;">
        <div class="w3-modal-content">
            <div class="w3-container w3-center">
                <h2>Error</h2>
                <p id="zyn-error-description">null</p>
                <button class="w3-button w3-border" onclick='(function() { document.getElementById("zyn-error-modal").style.display="none"; })()'>Ok</button>
            </div>
        </div>
    </div>

    <div class="w3-container w3-bar w3-black">
        <button class="w3-bar-item w3-button" onclick="_set_vissible_tab(tab_name_files)">Filesystem</button>
        <button class="w3-bar-item w3-button" onclick="_set_vissible_tab(tab_name_settings)">Settings</button>
    </div>

    <div id="tab-files" class="zyn-tabs" style="display:none">

        <div id="zyn-sidebar" class="w3-sidebar w3-bar-block w3-border" style="width: 25%;">
            <h3 class="w3-bar-item">Content</h3>
            <div id="file-list" style="min-width: 200px;"></div>
        </div>

        <div id="zyn-content" class="w3-container w3-margin-top w3-border">

            <button type="button" class="w3-button w3-border" onclick="_set_sidebar_size('min')">Min</button>
            <button type="button" class="w3-button w3-border" onclick="_set_sidebar_size('normal')">Normal</button>

            <div class="w3-half">
                <fieldset>
                    <legend>Current Directory</legend>
                    <div>
                        <input id="zyn-current-path" type="text" class="w3-input" disabled style="width:50%"></input>
                    </div>
                    <button id="zyn-button-parent-directory" href="#" class="w3-button w3-border" onclick="_handle_parent_directory_clicked()">Up</button>
                </fieldset>
            </div>

            <div class="w3-half">
                <fieldset >
                    <legend>Current File</legend>
                    <ul class="w3-ul w3-border-bottom">
                        <li class="w3-padding-small"><span>Name: </span><span id="zyn-current-file-name">null</span></li>
                        <li class="w3-padding-small"><span>Node Id: </span><span id="zyn-current-file-node-id">null</span></li>
                        <li class="w3-padding-small"><span>Type: </span><span id="zyn-current-file-type">null</span></li>
                        <li class="w3-padding-small"><span>Revision: </span><span id="zyn-current-file-revision">null</span></li>
                    </ul>
                    <button id="zyn-current-file-button-edit" class="w3-bar-item w3-button w3-border" onclick="_handle_edit_clicked()">Edit</button>
                    <button id="zyn-current-file-button-cancel" class="w3-bar-item w3-button w3-border" onclick="_handle_cancel_clicked()">Cancel</button>
                    <button id="zyn-current-file-button-save" class="w3-bar-item w3-button w3-border" onclick="_handle_save_edit_clicked()">Save</button>
                </fieldset>
            </div>

            <div class="w3-border">
                <p class="w3-center">Notifications</p>
                <table id="zyn-notifications" class="w3-table">
                    <tr>
                        <th>Source</th>
                        <th>Description</th>
                    </tr>
                </table>
                <div class="w3-center">
                    <button id="zyn-button-show-or-hide-notifications" data-state="show" class="w3-button w3-border" onclick="_handle_show_hide_notifications_clicked()">Show</button>
                </div>
            </div>

            <div id="zyn-document-content" class="w3-border ">
                <h1 class="w3-center w3-opacity"><b>Content</b></h1>
            </div>

        </div>
  </div>

  <div id="tab-settings" class="zyn-tabs" style="display:none">
      <h2>Settings</h2>
  </div>

  <script>
   class Transaction {
       constructor(on_success, state=null) {
           this._on_success = on_success;
           this._state = state;
       }

       state() {
           return this._state;
       }

       on_success(msg) {
           this._on_success(msg, this);
       }

       on_error() {
           alert('error');
       }

       on_notification() {
           alert('notification');

       }
   }

   class CurrentFile {
       constructor() {
           this._name = null;
           this._content = null;
           this._node_id = null;
           this._revision = null;
           this._type_of_file = null;
           this._extension = null;
           this._mode = null;
       }

       is_set() {
           if (this._name === null) {
               return false;
           }
           return true;
       }

       change_to(name, node_id, revision, type_of_file, bytes) {
           if (CurrentFile.file_types.indexOf(type_of_file) === -1) {
               alert('unkdnown file type');
               return ;
           }

           this._name = name;
           this._node_id = node_id;
           this._revision = revision;
           this._type_of_file = type_of_file;
           this._bytes = bytes;
           this._mode = CurrentFile.mode_view;

           this._extension = null;
           var split_name = this._name.split('.');
           if (split_name.length != 1) {
               this._extension = split_name[split_name.length - 1];
           }
       }

       is_editable() {
           if (['md', 'txt'].indexOf(this._extension) === -1) {
               return false;
           }
           return true;
       }

       set_mode(mode) {
           if (CurrentFile.modes.indexOf(mode) === -1) {
               alert('1');
               return ;
           }
           this._mode = mode;
       }

       update_revision(revision) {
           this._revision = revision;
       }

       mode() { return this._mode; }
       file_type() { return this._extension; }
       name() { return this._name; }
       node_id() { return this._node_id; }
       revision() { return this._revision; }
       type_of_file() { return this._type_of_file; }
       bytes() { return this._bytes; }
   };
   CurrentFile.mode_view = 'view';
   CurrentFile.mode_edit = 'edit';
   CurrentFile.modes = [CurrentFile.mode_view, CurrentFile.mode_edit];
   CurrentFile.file_type_random_access = 'random-access';
   CurrentFile.file_type_blob = 'blob';
   CurrentFile.file_types = [CurrentFile.file_type_random_access, CurrentFile.file_type_blob];

   var _current_file = new CurrentFile();
   var _current_workdir = new Path();

   function _set_button_activity(name, active) {
       var button = document.getElementById(name);
       if (active) {
           button.classList.remove("w3-disabled");
       } else {
           button.classList.add("w3-disabled");
       }
   }

   function _set_sidebar_size(size) {
       if (size === 'min') {
           document.getElementById('zyn-sidebar').style.width = '5%'
           document.getElementById('zyn-content').style.marginLeft = '7%'
       } else if (size === 'normal') {
           document.getElementById('zyn-sidebar').style.width = '25%'
           document.getElementById('zyn-content').style.marginLeft = '27%'
       } else {
           alert('unknown size');
       }
   }

   function _set_current_file(current_file)
   {
       _clear_current_file();
       document.getElementById('zyn-current-file-name').innerText = current_file.name();
       document.getElementById('zyn-current-file-node-id').innerText = current_file.node_id();
       document.getElementById('zyn-current-file-revision').innerText = current_file.revision();
       if (current_file.type_of_file() === CurrentFile.file_type_random_access) {
           document.getElementById('zyn-current-file-type').innerText = "Random Access";
       } else if (current_file.type_of_file() === CurrentFile.file_type_blob) {
           document.getElementById('zyn-current-file-type').innerText = "Blob";
       } else {
           alert('todo');
       }

       if (current_file.is_editable()) {
           if (current_file.mode() === CurrentFile.mode_view) {
               _set_button_activity('zyn-current-file-button-edit', true);
               _set_button_activity('zyn-current-file-button-save', true);
               _set_button_activity('zyn-current-file-button-cancel', false);
           } else if (current_file.mode() === CurrentFile.mode_edit) {
               _set_button_activity('zyn-current-file-button-edit', false);
               _set_button_activity('zyn-current-file-button-save', true);
               _set_button_activity('zyn-current-file-button-cancel', true);
           }
       }
   }

   function _clear_current_file()
   {
       document.getElementById('zyn-current-file-name').innerText = "";
       document.getElementById('zyn-current-file-node-id').innerText = "";
       document.getElementById('zyn-current-file-type').innerText = "";
       document.getElementById('zyn-current-file-revision').innerText = "";
       _set_button_activity('zyn-current-file-button-edit', false);
       _set_button_activity('zyn-current-file-button-save', false);
       _set_button_activity('zyn-current-file-button-cancel', false);
   }

   function _show_error(description)
   {
       document.getElementById("zyn-error-modal").style.display = "block";
       document.getElementById("zyn-error-description").innerText = description;
   }

   function _add_notification(source, description)
   {
       var notifications = document.getElementById("zyn-notifications");
       console.log(notifications)
       var size = notifications.rows.length;
       if (size > 5) {
           notifications.deleteRow(size - 1);
       }
       var row = notifications.insertRow(1);
       row.insertCell().innerText = source;
       row.insertCell().innerText = description;
   }

   function _change_notifications_display(display_style)
   {
       var notifications = document.getElementById("zyn-notifications");
       var size = notifications.rows.length;
       if (size < 2) {
           return ;
       }

       for (i = 2; i < size; i++) {
           notifications.rows[i].style.display = display_style
       }
   }

   function _handle_show_hide_notifications_clicked()
   {
       var notifications = document.getElementById('zyn-button-show-or-hide-notifications');

       if (notifications.dataset.state === 'show') {
           notifications.dataset.state = 'hide';
           notifications.innerText = 'Hide';
           _change_notifications_display('');
       } else if (notifications.dataset.state === 'hide') {
           notifications.dataset.state = 'show';
           notifications.innerText = 'Show';
           _change_notifications_display('none');
       } else {
           alert('todo');
       }
   }

   function _handle_save_edit_clicked()
   {
       if (! _current_file.is_set()) {
           return
       }

       if (_current_file.mode() !== CurrentFile.mode_edit) {
           return ;
       }

       var content_element = document.getElementById('zyn-edit-content');
       edited_content = content_element.innerText;

       if (['md'].indexOf(_current_file.file_type) !== -1) {
           edited_content = utf8.encode(edited_content);
       }

       if (_current_file.type_of_file() === CurrentFile.file_type_random_access) {
           zyn_edit_file_random_access(
               _current_file.node_id(),
               _current_file.revision(),
               _current_file.type_of_file(),
               _current_file.bytes(),
               edited_content,
               new Transaction(function (rsp) {
                   _current_file.update_revision(rsp['content']['revision']);
                   _set_current_file(_current_file);
               })
           );
       } else if (_current_file.type_of_file() === CurrentFile.file_type_blob) {
           zyn_edit_file_blob(
               _current_file.node_id(),
               _current_file.revision(),
               _current_file.type_of_file(),
               edited_content,
               new Transaction(function (rsp) {
                   _current_file.update_revision(rsp['content']['revision']);
                   _set_current_file(_current_file);
               })
           );
       } else {
           alert('Unhandled');
       }
   }

   function _handle_cancel_clicked()
   {
       if (! _current_file.is_set()) {
           return
       }

       if (_current_file.mode() !== CurrentFile.mode_edit) {
           return ;
       }

       _set_current_file_content();
       _current_file.set_mode(CurrentFile.mode_view);
       _set_current_file(_current_file);
   }

   function _handle_edit_clicked()
   {
       if (! _current_file.is_set()) {
           return
       }

       if (_current_file.mode() === CurrentFile.mode_edit) {
           return ;
       }

       var content_element = document.getElementById('zyn-document-content');
       content_element.innerHTML =
           '<pre id="zyn-edit-content" contenteditable="true">'
           + _current_file.bytes()
           + '</pre>'
       ;

       _current_file.set_mode(CurrentFile.mode_edit);
       _set_current_file(_current_file)
   }

   function _set_current_workdir(path) {
       var path_element = document.getElementById('zyn-current-path');
       path_element.value = path;
   }

   function _handle_change_current_workdir_rsp(rsp, transaction) {
       if (rsp['description']['type-of-element'] === 'directory') {
           var path = transaction.state()['path'];
           _set_current_workdir(path.to_str());
           _fetch_and_set_folder_content(path);
           _current_workdir = path;
       } else {
           alert('zxc');
       }
   }

   function _handle_parent_directory_clicked()
   {
       var path = _current_workdir.clone();
       path.parent();

       if (_current_workdir.is_equal(path)) {
           console.log('nochange');
           return ;
       }

       zyn_query_filesystem_element(path, new Transaction(
           _handle_change_current_workdir_rsp,
           state={'path': path}
       ));
   }

   function _handle_folder_content_list_item_clicked(element_type, name, node_id) {

       if (element_type === 'dir') {
           var path = _current_workdir.clone();
           path.append(name);

           zyn_query_filesystem_element(path, new Transaction(
               _handle_change_current_workdir_rsp,
               state={'path': path}
           ));

       } else if (element_type === 'file') {
           zyn_load_file(node_id, name, new Transaction(_handle_load_file_rsp));
       }
   }

   function _create_folder_list_element(element_data) {
       var element = document.createElement('a');
       element.setAttribute('class', 'w3-bar-item w3-button')
       element.addEventListener('click', function() { _handle_folder_content_list_item_clicked(
           element_data['element-type'],
           element_data['name'],
           element_data['node-id']);
       });

       if (element_data['element-type'] === 'file') {
           name = 'f ' + element_data['name']
       } else {
           name = 'd ' + element_data['name']
       }

       element.appendChild(document.createTextNode(name));
       return element;
   }

   function _fetch_and_set_folder_content(path)
   {
       zyn_load_folder_contents(path, new Transaction(function (rsp, _) {
           var file_list = document.getElementById("file-list");
           var elements = rsp['elements'];

           while (file_list.firstChild) {
               file_list.removeChild(file_list.firstChild);
           }

           for (let element of elements) {
               file_list.appendChild(_create_folder_list_element(element));
           }
       }));
   }

   function _handle_load_file_rsp(msg)
   {
       _current_file.change_to(
           msg['content']['filename'],
           msg['content']['node-id'],
           msg['content']['revision'],
           msg['content']['file-type'],
           atob(msg['content']['bytes'])
       );

       _set_current_file(_current_file);
       _set_current_file_content();
   }

   function _set_current_file_content() {

       var content_element = document.getElementById('zyn-document-content');
       while (content_element.firstChild) {
           content_element.removeChild(content_element.firstChild);
       }

       if (_current_file.file_type() == 'md') {
           var converter = new showdown.Converter();
           var decoded = utf8.decode(_current_file.bytes());
           var html = converter.makeHtml(decoded);
           content_element.innerHTML = html;
       } else if (_current_file.file_type() == 'pdf') {

           var root = document.createElement('div');
           // console.log('Loading pdf');

           var loadingTask = pdfjsLib.getDocument({data: _current_file.bytes()});
           loadingTask.promise.then(function(pdf) {
               // console.log('PDF loaded');

               var pageNumber = 1;
               for (var pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
                   pdf.getPage(pageNumber).then(function(page) {
                       // console.log('Page loaded');

                       var scale = 1.5;
                       var viewport = page.getViewport(scale);

                       var canvas = document.createElement('canvas');
                       root.appendChild(canvas);
                       var context = canvas.getContext('2d');
                       canvas.height = viewport.height;
                       canvas.width = viewport.width;
                       var renderContext = {
                           canvasContext: context,
                           viewport: viewport
                       };
                       var renderTask = page.render(renderContext);
                       renderTask.then(function () {
                           // console.log('Page rendered');
                       });
                   });
               }
           }, function (reason) {
               // PDF loading error
               console.error(reason);
           });
           content_element.appendChild(root);

       } else {
           content_element.innerHTML = '<pre>' + _current_file.bytes() + '</pre>';
       }
   }

  </script>

  <script>
   var tab_name_files = "tab-files";
   var tab_name_settings = "tab-settings";
   function _set_vissible_tab(tab_name) {
       var tabs = document.getElementsByClassName("zyn-tabs");
       for(let tab of tabs) {
           tab.style.display = "none";
       }
       document.getElementById(tab_name).style.display = "block";
   }

  </script>

  <script type="text/javascript">

   // Initialization
   _set_vissible_tab(tab_name_files);
   _clear_current_file();
   _change_notifications_display('none');
   _set_sidebar_size('normal');

   {% if is_logged_in == 0 %}

   document.getElementById("zyn-login-modal").style.display = "block"

   {% elif is_logged_in == 1 %}

   zyn_init("{{ user_id }}", new Transaction(function (_, _) {
       var path = _current_workdir.clone();
       _set_current_workdir(path.to_str());
       _fetch_and_set_folder_content(path);
       zyn_log_on_server('Client ready');
   }));

   {% end %}

  </script>

</body>
</html>
