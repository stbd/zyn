<!doctype html>
<head>
  <title>Zyn</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.slim.js"></script>
  <script type="text/javascript" src="https://cdn.rawgit.com/showdownjs/showdown/1.8.6/dist/showdown.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.489/pdf.js"></script>
  <script type="text/javascript" src="{{ static_url('zyn.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('utf8.js') }}"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>


  <div id="login-modal" class="w3-modal" style="display: none;">
    <div class="w3-modal-content">
      <div class="w3-container">
        <p>Login</p>

        <form class="w3-container" method="post">
          <label>Username</label>
          <input class="w3-input" type="text" name="username">

          <label>Password</label>
          <input class="w3-input" type="text" name="password">

          <input type="submit" value="{{ _("login") }}">

        </form>

      </div>
    </div>
  </div>

  <div class="w3-bar w3-black">
    <button class="w3-bar-item w3-button" onclick="_set_vissible_tab(tab_name_files)">Files</button>
    <button class="w3-bar-item w3-button" onclick="_set_vissible_tab(tab_name_settings)">Settings</button>
  </div>

  <div id="tab-files" class="zyn-tabs" style="display:none">

      <p>Directory</p>

      <a id="zyn-button-parent-directory" href="#" class="w3-bar-item w3-button" >Up</a>
      <button class="w3-bar-item w3-button" onclick="_handle_edit_clicked()">Edit</button>
      <button class="w3-bar-item w3-button" onclick="_handle_save_edit_clicked()">Save</button>

      <input id="zyn-current-path" type="text" class="w3-bar-item w3-input" disabled></input>

      <div id="file-list" class="w3-sidebar w3-bar-block w3-green" style="width:200px;">
      </div>

      <div style="margin-left:200px">
          <div id="zyn-document-content" class="w3-blue">
              <h1>Content</h1>
          </div>
      </div>
  </div>

  <div id="tab-settings" class="zyn-tabs" style="display:none">
      <h2>Settings</h2>
  </div>

  <script>
   var _current_file_content = null;
   var _current_file_name = null;
   var _current_file_node_id = null;
   var _current_file_revision = null;

   function _handle_zyn_error(error_description) {
       alert("Zyn error");
   }

   function _handle_save_edit_rsp()
   {
       console.log('edit done!')
   }

   function _handle_save_edit_clicked()
   {
       console.log('save clicked');
       var content_element = document.getElementById('zyn-edit-content');

       console.log('zxczxczxc')
       edited_content = content_element.innerText;
       console.log(edited_content)
       zyn_edit_file(
           _current_file_node_id,
           _current_file_revision,
           _current_file_content,
           utf8.encode(edited_content),
           utf8.encode(_handle_save_edit_rsp),
       );
   }

   function _handle_edit_clicked()
   {
       console.log('edit clicked');
       if (_current_file_content === null) {
           alert('no file');
           return ;
       }

       var content_element = document.getElementById('zyn-document-content');
       content_element.innerHTML =
           '<pre id="zyn-edit-content" contenteditable="true">'
           + _current_file_content
           + '</pre>'
       ;
   }

   function _handle_parent_directory_clicked()
   {
       var path_current = zyn_current_directory_path();
       var path_parent = zyn_current_directory_parent_path();
       // console.log('Moving to parent ' + path_current + ' ' + path_parent);
       if (path_current === path_parent) {
           return ;
       }
       zyn_change_current_directory(path_parent, _handle_change_current_directory_rsp, _handle_zyn_error);
   }

   function _set_current_directory(path) {
       var path_element = document.getElementById('zyn-current-path');
       // console.log('---', path_element, path)
       path_element.value = path;

   }

   function _handle_load_file_rsp(node_id, filename, revision, content) {

       _current_file_content = content;
       _current_file_name = filename;
       _current_file_node_id = node_id;
       _current_file_revision = revision;

       var content_element = document.getElementById('zyn-document-content');
       if (filename.endsWith('.md')) {
           var converter = new showdown.Converter();
           var decoded = utf8.decode(content);
           var html = converter.makeHtml(decoded);
           content_element.innerHTML = html;
       } else if (filename.endsWith('.pdf')) {

           var root = document.createElement('div');
           // console.log('Loading pdf');

           var loadingTask = pdfjsLib.getDocument({data: content});
           loadingTask.promise.then(function(pdf) {
               // console.log('PDF loaded');

               var pageNumber = 1;
               for (var pageNumber = 1; pageNumber <= pdf.numPages; pageNumber++) {
                   pdf.getPage(pageNumber).then(function(page) {
                       // console.log('Page loaded');

                       var scale = 1.5;
                       var viewport = page.getViewport(scale);

                       var canvas = document.createElement('canvas');
                       root.appendChild(canvas);
                       var context = canvas.getContext('2d');
                       canvas.height = viewport.height;
                       canvas.width = viewport.width;
                       var renderContext = {
                           canvasContext: context,
                           viewport: viewport
                       };
                       var renderTask = page.render(renderContext);
                       renderTask.then(function () {
                           // console.log('Page rendered');
                       });
                   });
               }
           }, function (reason) {
               // PDF loading error
               console.error(reason);
           });
           content_element.appendChild(root);

       } else {
           content_element.innerHTML = '<pre>' + content + '</pre>';
       }
   }

   function _handle_change_current_directory_rsp(path, exists) {
       // console.log('cd done ' + path + exists);
       _set_current_directory(path);
       _fetch_and_set_folder_content(path);
   }

   function _handle_folder_content_list_item_clicked(element_type, name, node_id) {

       if (element_type === 'dir') {
           var path_current = zyn_current_directory_path();
           var path_next = [path_current, name].join('/');
           // console.log('Changing path to ' + path_next);
           zyn_change_current_directory(path_next, _handle_change_current_directory_rsp, _handle_zyn_error);
       } else if (element_type === 'file') {
           zyn_load_file(node_id, name, _handle_load_file_rsp);
       }
   }

   function _create_folder_list_element(element_data) {
       var element = document.createElement('a');
       element.setAttribute('class', 'w3-bar-item w3-button')
       element.addEventListener('click', function() { _handle_folder_content_list_item_clicked(
           element_data['element-type'],
           element_data['name'],
           element_data['node-id']);
       });

       if (element_data['element-type'] === 'file') {
           name = 'f ' + element_data['name']
       } else {
           name = 'd ' + element_data['name']
       }

       element.appendChild(document.createTextNode(name));
       return element;
   }

   var tab_name_files = "tab-files";
   var tab_name_settings = "tab-settings";
   function _set_vissible_tab(tab_name) {
       var tabs = document.getElementsByClassName("zyn-tabs");
       for(let tab of tabs) {
           tab.style.display = "none";
       }
       document.getElementById(tab_name).style.display = "block";
   }

   function _handle_load_folder_content_response(rsp) {
       var file_list = document.getElementById("file-list");
       var elements = rsp['elements'];

       while (file_list.firstChild) {
           file_list.removeChild(file_list.firstChild);
       }

       for (let element of elements) {
           file_list.appendChild(_create_folder_list_element(element));
       }
   }

   function _fetch_and_set_folder_content(path) {

       zyn_load_folder_contents(path, _handle_load_folder_content_response, _handle_zyn_error);
   }

   function _handle_socket_initialized(rsp) {
       var path = zyn_current_directory_path();
       _set_current_directory(path);
       _fetch_and_set_folder_content(path);
       zyn_log_on_server('Client ready');
   }

  </script>

  <script type="text/javascript">

   // Initialization
   _set_vissible_tab(tab_name_files);
   var parent_button = document.getElementById('zyn-button-parent-directory');
   parent_button.addEventListener(
       'click',
       _handle_parent_directory_clicked,
   );

   {% if is_logged_in == 0 %}

   document.getElementById("login-modal").style.display="block"

   {% elif is_logged_in == 1 %}

   zyn_init("{{ user_id }}", _handle_socket_initialized, _handle_zyn_error);

   {% end %}

  </script>

</body>
</html>
